<!-- omit in toc -->
# ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«

ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ã®å®šç¾©ãƒ»ä½œæˆ<br>
ã“ã‚Œã¾ã§Djangoã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãã¾ã—ãŸãŒã€ã“ã“ã§ç‹¬è‡ªã®ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ã¸ä½œã‚Šæ›¿ãˆã¾ã™<br>
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ã¯èªè¨¼ã«é–¢ã‚ã‚‹ã‚³ã‚¢ãªéƒ¨åˆ†ã®ã¿ã¨ã—ã€ãã®ã»ã‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ï¼ˆç”Ÿå¹´æœˆæ—¥ï¼‰ã«ã¤ã„ã¦åˆ¥ã§`Profile`ãƒ¢ãƒ‡ãƒ«ã‚’å®Ÿè£…ã—ã€ãã¡ã‚‰ã‚’OneToOneã§é–¢é€£ã•ã›ã¾ã™ã€‚<br>
å®Ÿè£…ãŒå®Œäº†ã—ãŸæ®µéšã§ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç­‰ã‚’ä½œã‚Šç›´ã—ã€æ”¹ã‚ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚„ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç™»éŒ²ã—ã¦ã„ãã¾ã™ã€‚<br>
[å‚è€ƒurl: OneToOneFieldã‚’åˆ©ç”¨ã—ã¦Userãƒ¢ãƒ‡ãƒ«ã‚’æ‹¡å¼µã™ã‚‹](https://daeudaeu.com/django-user-onetoonefield/)
[å‚è€ƒurl: Djangoã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.djangoproject.com/ja/3.2/topics/auth/customizing/#a-full-example)<br>

- [ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ä½œæˆ](#ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ä½œæˆ)
  - [base/models/__init__.py](#basemodelsinitpy)
  - [base/models/account_models.pyã€€ä½œæˆ](#basemodelsaccount_modelspyä½œæˆ)
  - [ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«èª¬æ˜](#ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«èª¬æ˜)
    - [receiver, post_save, sender](#receiver-post_save-sender)
    - [BaseUserManager, AbstractBaseUser](#baseusermanager-abstractbaseuser)
- [config/setting.py](#configsettingpy)
  - [ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½ã«ã¤ã„ã¦](#ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½ã«ã¤ã„ã¦)
- [base/forms.pyã‚’ä½œæˆ](#baseformspyã‚’ä½œæˆ)
- [base/admin.py ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨­å®š](#baseadminpy-ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨­å®š)
- [DBå‰Šé™¤ã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´å‰Šé™¤](#dbå‰Šé™¤ã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´å‰Šé™¤)
- [postgresãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆ](#postgresãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆ)
- [ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã€æ–°ã—ãã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œã‚Šç›´ã™](#ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—æ–°ã—ãã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œã‚Šç›´ã™)
- [ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã€ç®¡ç†è€…ç”»é¢ã«ãƒ­ã‚°ã‚¤ãƒ³ã€ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ ](#ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ç®¡ç†è€…ç”»é¢ã«ãƒ­ã‚°ã‚¤ãƒ³ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ )
- [ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½](#ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½)
  - [config/urls.py](#configurlspy)
  - [templates/snippets/header.html](#templatessnippetsheaderhtml)
  - [view](#view)
    - [base/views/__init__.py    account_views.pyã®è¿½åŠ ](#baseviewsinitpy----account_viewspyã®è¿½åŠ )
    - [base/views/account_views.py](#baseviewsaccount_viewspy)
      - [ãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆæ©Ÿèƒ½(ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹äººã ã‘ãŒé–‹ã‘ã‚‹ãƒšãƒ¼ã‚¸)ã®è¿½åŠ  LoginRequiredMixin, login_required](#ãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆæ©Ÿèƒ½ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹äººã ã‘ãŒé–‹ã‘ã‚‹ãƒšãƒ¼ã‚¸ã®è¿½åŠ -loginrequiredmixin-login_required)
  - [templates](#templates)
    - [templates/pages/login_signup.html](#templatespageslogin_signuphtml)
    - [templates/pages/account.html](#templatespagesaccounthtml)
    - [templates/pages/profile.html æ–°ã—ãä½œæˆ](#templatespagesprofilehtml-æ–°ã—ãä½œæˆ)
- [git push](#git-push)
- [04_1èª•ç”Ÿæ—¥ã®å…¥åŠ›ã¯ã‚»ãƒ¬ã‚¯ãƒˆãŒã‚„ã‚Šã‚„ã™ã„.mdã¸ç¶šã](#04_1èª•ç”Ÿæ—¥ã®å…¥åŠ›ã¯ã‚»ãƒ¬ã‚¯ãƒˆãŒã‚„ã‚Šã‚„ã™ã„mdã¸ç¶šã)



## ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ä½œæˆ

base<br>
â”œâ”€â”€ models<br>
â”‚   â”œâ”€â”€ __init__.py<br>
â”‚   â”œâ”€â”€ account_models.pyã€€ã€€è¿½åŠ <br>
â”‚   â””â”€â”€ item_models.py<br>
<br><br>

### base/models/__init__.py

```python
    from .item_models import *
+   from .account_models import *
```

### base/models/account_models.pyã€€ä½œæˆ

```python
from django.dispatch import receiver
from django.db.models.signals import post_save
from django.db import models
from django.contrib.auth.models import BaseUserManager, AbstractBaseUser
from base.models import create_id # item_models.py ã®create_idé–¢æ•°(22æ–‡å­—ã®ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã‚’ä½œã‚‹)
from datetime import date # å¹´é½¢è¨ˆç®—ç”¨
from dateutil.relativedelta import relativedelta # å¹´é½¢è¨ˆç®—ç”¨

# Djangoã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

class UserManager(BaseUserManager):
    # usernameã¨emailã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹
    def create_user(self, username, email, password=None):
        if not email:
            raise ValueError('Users must have an email address')
        user = self.model(
            username=username,
            email=self.normalize_email(email),
        )
        user.set_password(password)
        user.save(using=self._db)
        return user

    def create_superuser(self, username, email, password=None):
        user = self.create_user(
            username,
            email,
            password=password,
        )
        user.is_admin = True
        user.save(using=self._db)
        return user

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ã‚¢æƒ…å ±
class User(AbstractBaseUser):
    id = models.CharField(default=create_id, primary_key=True, max_length=22)
    username = models.CharField(
        max_length=50, unique=True, blank=True, default='åŒ¿å')
    email = models.EmailField(max_length=255, unique=True)
    is_active = models.BooleanField(default=True)
    is_admin = models.BooleanField(default=False)
    objects = UserManager()
    USERNAME_FIELD = 'username'
    EMAIL_FIELD = 'email'
    REQUIRED_FIELDS = ['email', ]

    def __str__(self):
        return self.email

    def has_perm(self, perm, obj=None):
        "Does the user have a specific permission?"
        # Simplest possible answer: Yes, always
        return True

    def has_module_perms(self, app_label):
        "Does the user have permissions to view the app `app_label`?"
        # Simplest possible answer: Yes, always
        return True

    @property
    def is_staff(self):
        "Is the user a member of staff?"
        # Simplest possible answer: All admins are staff
        return self.is_admin


#ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ã‚¢æƒ…å ±ã¨ç´ã¥ã„ã¦ã„ã‚‹
# blank=True ä»»æ„ã§å…¥åŠ›ã§OK (æ³¨æ–‡æ™‚ã«ã¯ç©ºç™½NGã¨ã™ã‚‹)
class Profile(models.Model):
    # OneToOneField 1å¯¾1ã§ç´ã¥ã.
    # on_delete=models.CASCADE ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ã‚¢æƒ…å ±ãŒå‰Šé™¤ã•ã‚ŒãŸã‚‰ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚‚å‰Šé™¤ã™ã‚‹ã‚ˆ
    user = models.OneToOneField(
        User, primary_key=True, on_delete=models.CASCADE)
    name = models.CharField(default='', blank=True, max_length=50) # åå‰(å®›å)
    tel = models.CharField(default='', blank=True, max_length=15) # tel
    birth_day = models.DateField(blank=True, null=True) # ç”Ÿå¹´æœˆæ—¥
    created_at = models.DateTimeField(auto_now_add=True) # ä½œæˆæ—¥
    updated_at = models.DateTimeField(auto_now=True) # æ›´æ–°æ—¥

    def __str__(self):
        return self.name

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ã‚¢æƒ…å ±ä½œæˆæ™‚ã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚‚åŒæ™‚ã«ä½œã‚Œã‚‹
# OneToOneFieldã‚’åŒæ™‚ã«ä½œæˆ
@receiver(post_save, sender=User) # Userãƒ¢ãƒ‡ãƒ«ãŒå…¥åŠ›ä¿å­˜ã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œã™ã‚‹
def create_onetoone(sender, **kwargs):
    if kwargs['created']:
        Profile.objects.create(user=kwargs['instance'])
```

### ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«èª¬æ˜
[å‚è€ƒurl:Django AbstractBaseUserã§ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ](https://noumenon-th.net/programming/2019/12/13/abstractbaseuser/)

  1. receiver, post_save, sender
  2. BaseUserManager, AbstractBaseUser

#### receiver, post_save, sender
`@receiver(post_save, sender=User)`<br>
post_saveï¼šUserãƒ¢ãƒ‡ãƒ«ãŒsaveãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè¡Œã‚’å®Œäº†ã—ãŸã®ã‚’å—ã‘ã¦å‹•ã

```python
from django.dispatch import receiver
from django.db.models.signals import post_save


# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ã‚¢æƒ…å ±
class User(AbstractBaseUser):
    ...

#ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ã‚¢æƒ…å ±ã¨ç´ã¥ã„ã¦ã„ã‚‹
class Profile(models.Model):
    ...

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ã‚¢æƒ…å ±ä½œæˆæ™‚ã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚‚åŒæ™‚ã«ä½œã‚Œã‚‹
# OneToOneFieldã‚’åŒæ™‚ã«ä½œæˆ
@receiver(post_save, sender=User) # Userãƒ¢ãƒ‡ãƒ«ãŒå…¥åŠ›ä¿å­˜ã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œã™ã‚‹
def create_onetoone(sender, **kwargs):
    if kwargs['created']:
        Profile.objects.create(user=kwargs['instance'])
```

#### BaseUserManager, AbstractBaseUser
[å‚è€ƒurl:Django Userãƒ¢ãƒ‡ãƒ«ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹æ–¹æ³•](https://itc.tokyo/django/user/)


## config/setting.py

```python

# ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã†ãŸã‚ã®è¨­å®š
AUTH_USER_MODEL = 'base.User' # base.Userãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã†

LOGIN_URL = '/login/' # æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«é·ç§»ã™ã‚‹URL

LOGIN_REDIRECT_URL = '/' # ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸå¾Œã«é·ç§»ã™ã‚‹URL

LOGOUT_URL = '/logout/'

LOGOUT_REDIRECT_URL = '/login/' # ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ãŸå¾Œã«é·ç§»ã™ã‚‹URL

ä¸€ç•ªä¸‹ã«è¿½è¨˜ã™ã‚‹
```

### ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½ã«ã¤ã„ã¦
Djangoã®`LogoutViewæ©Ÿèƒ½ã‚’ä½¿ã†ã¨ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã®viewã‚’çœç•¥`ã§ãã‚‹<br>
config/urls.pyã¨header.htmlã¯ãã‚Œãã‚Œã®ãƒšãƒ¼ã‚¸ã«è¨˜è¼‰ã—ã¦ã„ã‚‹<br>

```python
# config/setting.py
LOGOUT_URL = '/logout/'
LOGOUT_REDIRECT_URL = '/login/'


# config/urls.py
from django.contrib.auth.views import LogoutView
urlpatterns = [
    path('logout/', LogoutView.as_view()),
]

# templates/snippets/header.html
<nav>
<a href="/logout/">Logout</a>
</nav>
```

## base/forms.pyã‚’ä½œæˆ

base<br>
â”œâ”€â”€ __pycache__<br>
â”œâ”€â”€ migrations<br>
â”œâ”€â”€ models<br>
â”œâ”€â”€ views<br>
â”œâ”€â”€ __init__.py<br>
â”œâ”€â”€ admin.py<br>
â”œâ”€â”€ apps.py<br>
â”œâ”€â”€ forms.pyã€€ã€€è¿½åŠ <br>
â””â”€â”€ tests.py<br>


base/forms.py

```python
from django import forms
from django.contrib.auth import get_user_model


class UserCreationForm(forms.ModelForm):
    password = forms.CharField()

    class Meta:
        model = get_user_model()
        fields = ('username', 'email', 'password', )

    def clean_password(self):
        # cleaned_dataã«ã¯formã®ä¸­ã§ æ¤œè¨¼ã•ã‚ŒãŸå¾Œé©åˆ‡ãªãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ç¢ºèªã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒå…¥ã‚Šã¾ã™ã€‚
        password = self.cleaned_data.get("password")
        return password

    def save(self, commit=True):
        user = super().save(commit=False)
        user.set_password(self.cleaned_data["password"])
        if commit:
            user.save()
        return user
```

##  base/admin.py ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨­å®š

```python

    from django.contrib import admin
    from django.contrib.auth.models import Group
-   from base.models import Item, Tag
+   from base.models import Item, Tag, User, Profile
+   from base.forms import UserCreationForm
+   from django.contrib.auth.admin import UserAdmin

    class TagInline(admin.TabularInline):
        model = Item.tags.through

    class ItemAdmin(admin.ModelAdmin):
        inlines = [TagInline]
        exclude = ['tags']

+   # ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨
+   class ProfileInline(admin.StackedInline):
+       model = Profile
+       can_delete = False

+   class CustomUserAdmin(UserAdmin):
+       # ç®¡ç†ç”»é¢ã«è¡¨ç¤ºã™ã‚‹ã‚‚ã®. 2æ®µã«åˆ†ã‘ã¦è¡¨ç¤º
+       fieldsets = (
+           (None, {'fields': ('username', 'email', 'password',)}),
+           (None, {'fields': ('is_active', 'is_admin',)}),
+       )

+       list_display = ('username', 'email', 'is_active',)
+       list_filter = ()
+       ordering = () # ä¸€è¦§è¡¨ç¤ºã®ä¸¦ã³æ›¿ãˆã®ã‚­ãƒ¼ã®è¨­å®šãŒã§ãã‚‹ ä»Šå›æœªä½¿ç”¨
+       filter_horizontal = ()

+       # ç®¡ç†ç”»é¢ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹ã¨ãã«ä½¿ã†é …ç›®ã®è¨­å®š
+       add_fieldsets = (
+           (None, {'fields': ('username', 'email', 'is_active',)}),
+       )

+       # ç®¡ç†ç”»é¢ã§ã‚‚è‡ªä½œã®ãƒ•ã‚©ãƒ¼ãƒ ãŒä½¿ãˆã‚‹
+       add_form = UserCreationForm
+       # ç®¡ç†ç”»é¢ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒšãƒ¼ã‚¸ã«åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å…¥ã‚Œã‚‹
+       inlines = (ProfileInline,)

    admin.site.register(Item, ItemAdmin)
    admin.site.register(Tag)
+   admin.site.register(User, CustomUserAdmin) # ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§è¿½åŠ 
    admin.site.unregister(Group)  # å…ƒã‹ã‚‰ã‚ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½¿ã‚ãªã„ã®ã§éè¡¨ç¤ºã«
```

## DBå‰Šé™¤ã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´å‰Šé™¤
1. base/migrations ã®ä¸­ã® 0001_initial.pyã‚’å‰Šé™¤
2. base/migrations/pycache ã®ä¸­ã® 0001_initial.cpython-39.pycã‚’å‰Šé™¤(pythonã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«)
3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å‰Šé™¤ã™ã‚‹(sqlite3ã®æ™‚ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã™ã‚‹)
  postgresãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å‰Šé™¤ã™ã‚‹ã‚„ã‚Šæ–¹

  ```python
  # psql postgresã«å…¥ã‚‹
  (myvenv) niko@kunikonoMacBook-Pro basketball-tube % psql postgres
  # dbã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹
  postgres=# drop database db_basketball_tube;
  DROP DATABASE
  ```

## postgresãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆ

```python
(myvenv) niko@kunikonoMacBook-Pro basketball-tube % psql postgres
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œã‚‹
postgres=# CREATE DATABASE db_basketball_tube;
CREATE DATABASE
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãªã©ã¯01_ç’°å¢ƒè¨­å®šã§ã—ã¦ã„ã‚‹ã®ã§ã—ãªãã¦è‰¯ã„
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãã£ã¤ã‘ã‚‹
postgres=# GRANT ALL PRIVILEGES ON DATABASE db_basketball_tube TO user_basketball_tube;
GRANT
postgres=#
\q
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒã§ãã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹
(myvenv) niko@kunikonoMacBook-Pro basketball-tube % psql -U user_basketball_tube -d db_basketball_tube
db_basketball_tube=>
\q
```

## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã€æ–°ã—ãã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œã‚Šç›´ã™

```python
(myvenv) niko@kunikonoMacBook-Pro basketball-tube % python manage.py makemigrations
Migrations for 'base':
  base/migrations/0001_initial.py
    - Create model User
    - Create model Tag
    - Create model Profile
    - Create model Item
(myvenv) niko@kunikonoMacBook-Pro basketball-tube % python manage.py migrate
...
(myvenv) niko@kunikonoMacBook-Pro basketball-tube % python manage.py createsuperuser
Username: matsuo
Email: matsuokuniko7@gmail.com
Password:
Password (again):
Superuser created successfully.
```

base<br>
â”œâ”€â”€ migrations<br>
â”‚   â”œâ”€â”€ __pycache__<br>
â”‚   â”œâ”€â”€ __init__.py<br>
â”‚   â””â”€â”€ 0001_initial.pyã€€ã€€è‡ªå‹•ã§ä½œã‚‰ã‚Œã¦ã„ã‚‹<br>



## ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã€ç®¡ç†è€…ç”»é¢ã«ãƒ­ã‚°ã‚¤ãƒ³ã€ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ 
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ã®ä¸‹ã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¢ãƒ‡ãƒ«ã‚‚è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã®ã‚’ç¢ºèª
<img src='img/2022-10-02-14-27-39.png' width='100%'>
<br><br>

- ã‚¢ã‚¤ãƒ†ãƒ ãƒ¢ãƒ‡ãƒ«ä½œæˆæ™‚ã«ä½œã£ãŸã‚¢ã‚¤ãƒ†ãƒ 3ã¤ã¯å‰Šé™¤ã—ãŸã®ã§ã€æ–°ã—ã3ã¤å…¥åŠ›ã™ã‚‹(å†™çœŸçœç•¥)

## ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½
### config/urls.py

```python
    from django.contrib import admin
    from django.urls import path
    from base import views
+   from django.contrib.auth.views import LogoutView # è¿½åŠ  viewã¯è‡ªä½œã›ãšdjangoã®æ©Ÿèƒ½ã‚’ä½¿ã†

    urlpatterns = [
        path('admin/', admin.site.urls),

        path('', views.IndexListView.as_view()),  # ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸
        path('items/<str:pk>/', views.ItemDetailView.as_view()),  # å€‹åˆ¥ã®Itemè©³ç´°ãƒšãƒ¼ã‚¸

+       # Account è¿½åŠ 
+       path('login/', views.Login.as_view()),
+       path('logout/', LogoutView.as_view()),
+       path('signup/', views.SignUpView.as_view()),
+       path('account/', views.AccountUpdateView.as_view()),
+       path('profile/', views.ProfileUpdateView.as_view()),
+   ]
```

### templates/snippets/header.html

```html
    <div class="py-1 bg-dark ">
      <nav class="container d-flex flex-column flex-md-row justify-content-between">
        <a class="py-2 text-white" href="/">ğŸ€Ryukoku</a>
        <a class="py-2 d-none d-md-inline-block text-white" href="/orders/">Orders</a>
        <a class="py-2 d-none d-md-inline-block text-white" href="/profile/">Profile</a>
        <a class="py-2 d-none d-md-inline-block text-white" href="/account/">Account</a>
        <a class="py-2 d-none d-md-inline-block text-white" href="/cart/">Cart</a>
+       <!-- ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã‹ã€ã—ã¦ã„ãªã„ã‹ã§å‡ºã—ã‚ã‘ -->
+       {% if user.is_authenticated %}
+       <a class="py-2 d-none d-md-inline-block text-white" href="/logout/">Logout</a>
+       {% else %}
+       <a class="py-2 d-none d-md-inline-block text-white" href="/login/">Login</a>
+       <a class="py-2 d-none d-md-inline-block text-white" href="/signup/">SignUp</a>
        {% endif %}
      </nav>
    </div>
```

ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹<br>
<img src='img/2022-10-02-14-32-26.png' width='100%'>
ãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹<br>
<img src='img/2022-10-02-14-33-07.png' width='100%'>

### view

base/views<br>
â”œâ”€â”€ __pycache__<br>
â”œâ”€â”€ __init__.py<br>
â”œâ”€â”€ account_views.pyã€€ã€€è¿½åŠ <br>
â””â”€â”€ item_views.py<br>

#### base/views/__init__.py    account_views.pyã®è¿½åŠ 

```python
    from .item_views import *
+   from .account_views import *
```

#### base/views/account_views.py

```python
from django.views.generic import CreateView, UpdateView
from django.contrib.auth.views import LoginView
from django.contrib.auth.mixins import LoginRequiredMixin # ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹äººã ã‘
from django.contrib.auth import get_user_model
from base.models import Profile
from base.forms import UserCreationForm

class SignUpView(CreateView):
    form_class = UserCreationForm
    success_url = '/login/'
    template_name = 'pages/login_signup.html'

    def form_valid(self, form):
        return super().form_valid(form)

class Login(LoginView):
    template_name = 'pages/login_signup.html'

    def form_valid(self, form):
        return super().form_valid(form)

    def form_invalid(self, form):
        return super().form_invalid(form)

# ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹äººã ã‘ãŒé–‹ã‘ã‚‹ãƒšãƒ¼ã‚¸
# login_requiredã¯defã®ã¨ãã«ä½¿ã†ã®ã§
# ä»Šå›ã¯ã€ã‚¯ãƒ©ã‚¹ç”¨ã®LoginRequiredMixinã‚’ä½¿ã†
class AccountUpdateView(LoginRequiredMixin, UpdateView):
    model = get_user_model()
    template_name = 'pages/account.html'
    fields = ('username', 'email',)
    success_url = '/account/' # æ›´æ–°å¾Œã‚‚åŒã˜ãƒšãƒ¼ã‚¸ã‚’è¿”ã™

    def get_object(self):
        # URLå¤‰æ•°ã§ã¯ãªãã€ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ç›´æ¥pkã‚’å–å¾—
        self.kwargs['pk'] = self.request.user.pk
        return super().get_object()

class ProfileUpdateView(LoginRequiredMixin, UpdateView):
    model = Profile
    template_name = 'pages/profile.html'
    fields = ('name', 'tel')
    success_url = '/profile/'

    def get_object(self):
        # URLå¤‰æ•°ã§ã¯ãªãã€ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ç›´æ¥pkã‚’å–å¾—
        self.kwargs['pk'] = self.request.user.pk
        return super().get_object()
```

##### ãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆæ©Ÿèƒ½(ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹äººã ã‘ãŒé–‹ã‘ã‚‹ãƒšãƒ¼ã‚¸)ã®è¿½åŠ  LoginRequiredMixin, login_required
[å‚è€ƒurl](https://itc.tokyo/django/loginrequiredmixin/)
ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹äººã ã‘ãŒé–‹ã‘ã‚‹ãƒšãƒ¼ã‚¸ã‚’ä½œã‚‹æ™‚ã«ä½¿ã†
LoginRequiredMixinï¼šã€€è‡ªå‹•çš„ã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¦ãã‚Œã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ã¯å…ƒã„ãŸãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹è¨­å®š
ã‚¯ãƒ©ã‚¹ç”¨ã¨defç”¨ãŒã‚ã‚Šã€æ›¸ãæ–¹ãŒã¡ãŒã†<br>

```python
# viewã«æ›¸ã
# ã‚¯ãƒ©ã‚¹ç”¨

from django.contrib.auth.mixins import LoginRequiredMixin # ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹äººã ã‘(ã‚¯ãƒ©ã‚¹ç”¨)

class AccountUpdateView(LoginRequiredMixin, UpdateView):


# defç”¨

from django.contrib.auth.decorators import login_required # ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹äººã ã‘(defç”¨)

@login_required   # ãƒ‡ã‚³ãƒ¬ãƒ¼ãƒ€ãƒ¼ã§ä½¿ã†
def remove_from_cart(request, pk): # pk:Itempk
```



### templates
#### templates/pages/login_signup.html
ãƒ­ã‚°ã‚¤ãƒ³ã¨ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã‚’ä¸€æšã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã—ã¦ã„ã‚‹<br>
ãƒ­ã‚°ã‚¤ãƒ³ã¨ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã‚’å‡ºã—åˆ†ã‘ã‚‹<br>

```html
<!-- ãƒ­ã‚°ã‚¤ãƒ³ã¨ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã‚’ä¸€æšã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã—ã¦ã„ã‚‹ -->
<!-- ãƒ­ã‚°ã‚¤ãƒ³ã¨ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã‚’å‡ºã—åˆ†ã‘ã‚‹ -->
{% extends 'base.html' %}

{% block main %}
<div class="container my-5">
  <div class="row ">
    <div class="col-12">
      <h1>
        <!-- ãƒ­ã‚°ã‚¤ãƒ³ã¨ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã‚’å‡ºã—åˆ†ã‘ã‚‹ -->
        <!-- request.pathã®ä¸­ã«loginãŒã‚ã‚Œã°... -->
        {% if 'login' in request.path %}
        Login
        {% elif 'signup' in request.path %}
        Signup
        {% endif %}
      </h1>
      <form method="POST">
        {% csrf_token %}
        <div class="form-row">
          <div class="form-group col-md-4">
            <input type="text" class="form-control" name="username" placeholder="Username">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-4">
            <input type="email" class="form-control" name="email" placeholder="Email" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-4">
            <input type="password" class="form-control" name="password" placeholder="Password" required>
          </div>
        </div>
        <button class="btn btn-info btm-sm" type="submit">
          <!-- ãƒ­ã‚°ã‚¤ãƒ³ã¨ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã‚’å‡ºã—åˆ†ã‘ã‚‹ -->
          {% if 'login' in request.path %}
          Login
          {% elif 'signup' in request.path %}
          Signup
          {% endif %}
        </button>
      </form>
    </div>
  </div>
</div>

{% endblock %}
```
<table>
<tr>
<td width="49%">

`request.pathã®ä¸­ã«login`ãŒã‚ã‚‹æ™‚<br>
http://127.0.0.1:8000/login/
</td>
<td width="49%">

`request.pathã®ä¸­ã«signup`ãŒã‚ã‚‹æ™‚<br>
http://127.0.0.1:8000/signup/
</td>
</tr>
<tr>
<td width="49%">
<img src='img/2022-10-02-15-44-53.png' width='100%'>
</td>
<td width="49%">
<img src='img/2022-10-02-15-45-11.png' width='100%'>
</td>
</tr>
</table>

#### templates/pages/account.html

ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç”»é¢ä¸Šã§å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®ãƒšãƒ¼ã‚¸

```html
<!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç”»é¢ä¸Šã§å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®ãƒšãƒ¼ã‚¸ -->
{% extends 'base.html' %}

{% block main %}

<div class="container my-5">
  <div class="row">
    <div class="col-12">
      <h1>Account</h1>
      <form method="POST">
        {% csrf_token %}
        <div class="form-row">
          <div class="form-group col-md-4">
            <label>Username</label>
            <input class="form-control" type="text" name="username" placeholder="name" value="{{user.username}}">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-4">
            <label>Email</label>
            <input class="form-control" type="email" name="email" placeholder="Email" value="{{user.email}}" required>
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Save</button>
      </form>
    </div>
  </div>
</div>

{% endblock %}
```

`LoginRequiredMixin`ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹äººã ã‘ãŒå…¥ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹
<table>
<tr>
<td width="49%">

ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹æ™‚<br>
http://127.0.0.1:8000/account/<br>
ã€€
</td>
<td width="49%">

ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„æ™‚<br>
http://127.0.0.1:8000/login/?next=/account/<br>
ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸã‚‰ã€http://127.0.0.1:8000/account/ã¸é·ç§»ã™ã‚‹ã‚ˆ
</td>
</tr>
<tr>
<td width="49%">
<img src='img/2022-10-02-15-51-02.png' width='100%'>
</td>
<td width="49%">
<img src='img/2022-10-02-15-51-31.png' width='100%'>
</td>
</tr>
</table>





#### templates/pages/profile.html æ–°ã—ãä½œæˆ

ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç”»é¢ä¸Šã§å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®ãƒšãƒ¼ã‚¸

```html
<!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç”»é¢ä¸Šã§å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®ãƒšãƒ¼ã‚¸ -->

{% extends 'base.html' %}

{% block main %}

<div class="container my-5">
  <div class="row">
    <div class="col-12">
      <h1>Profile</h1>
      <form method="POST">
        {% csrf_token %}
        <div class="form-group ">
          <label>Name</label>
          <input class="form-control" type="text" name="name" placeholder="name" value="{{user.profile.name}}">
        </div>
        <div class="form-group">
          <label>Tel</label>
          <input class="form-control" type="tel" name="tel" placeholder="tel" value="{{user.profile.tel}}">
        </div>
        <div class="form-group">
          <label>Birthday</label>
          <input class="form-control" type="date" name="birthday" placeholder="birthday" value="{{user.profile.birth_day}}">
        </div>
        <button type="submit" class="btn btn-primary">Save</button>
      </form>
    </div>
  </div>
</div>

{% endblock %}
```

account.htmlåŒæ§˜ã«`LoginRequiredMixin`ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹äººã ã‘ãŒå…¥ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹
<table>
<tr>
<td width="49%">

ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹æ™‚<br>
http://127.0.0.1:8000/profile/<br>
</td>
<td width="49%">

ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„æ™‚<br>
account.htmlåŒæ§˜ã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æ¨ç§»ã—ã€ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€profile.htmlã‚’ã‹ãˆã™<br>
</td>
</tr>
<tr>
<td width="49%">
<img src='img/2022-10-02-16-17-07.png' width='100%'>
</td>
<td width="49%">
</td>
</tr>
</table>


## git push
`git commit -m"custom_user, login-logout add"`<br>
<br><br>
ä»Šå¾Œã®herokuã¸ã®pushã¯æ©Ÿèƒ½ãŒæƒã£ã¦ã‹ã‚‰è¡Œã£ã¦ã„ãã€‚
<br><br><br><br>


## 04_1èª•ç”Ÿæ—¥ã®å…¥åŠ›ã¯ã‚»ãƒ¬ã‚¯ãƒˆãŒã‚„ã‚Šã‚„ã™ã„.mdã¸ç¶šã